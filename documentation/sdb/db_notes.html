<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<!--

    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE- 2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->

  <link href="/jena-doc/css/jena.css" rel="stylesheet" type="text/css">

  <title>Apache Jena - SDB Database Notes</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
  <script src="/js/jena-navigation.js" type="text/javascript"></script>
</head>

<body>
  <div id="header">
    <div id="logoblock">
    <img alt="Apache Jena" src="/images/jena-logo/jena-logo-small.png"/>
    </div>

    <div id="titleblock">
      <h1 class="title">Apache Jena</h1>
      <div id="topmenu" class="tabbar round-10">
        <ul>
        <li class="round-top-8"><a class="round-top-8" href="/jena-doc/index.html" id="home_menu">Home</a></li>
        <li class="round-top-8"><a class="round-top-8" href="/jena-doc/help_and_support/index.html">Support</a></li>
        <li class="round-top-8"><a class="round-top-8" href="/jena-doc/getting_started/index.html">Getting started</a></li>
        <li class="round-top-8"><a class="round-top-8" href="/jena-doc/tutorials/index.html">Tutorials</a></li>
        <li class="round-top-8"><a class="round-top-8" href="/jena-doc/documentation/index.html">Documentation</a></li>
        </ul>
      </div>
    </div>
  </div>

  <div id="navigation" class="clear">
  <h1 id="quick-links">Quick links</h1>
<ul>
<li><a href="/jena-doc/index.html">Home</a></li>
<li><a href="/jena-doc/download/index.html">Downloads</a></li>
<li><a href="/jena-doc/help_and_support/index.html">Help and support</a></li>
<li><a href="/jena-doc/help_and_support/bugs_and_suggestions.html">Report a bug</a></li>
<li><a href="/jena-doc/about_jena/roadmap.html">Roadmap</a></li>
<li><a href="/jena-doc/getting_involved/index.html">Getting involved</a></li>
<li><a href="/jena-doc/documentation/">Documentation</a></li>
</ul>
<h1 id="about-jena">About Jena</h1>
<ul>
<li><a href="/jena-doc/index.html">Home</a></li>
<li><a href="/jena-doc/about_jena/about.html">About Jena</a></li>
<li><a href="/jena-doc/about_jena/architecture.html">Architecture</a></li>
<li><a href="/jena-doc/about_jena/roadmap.html">Roadmap</a></li>
<li><a href="/jena-doc/about_jena/team.html">Project team</a></li>
<li><a href="/jena-doc/about_jena/contributions.html">Related projects</a></li>
</ul>
<h1 id="download">Download</h1>
<ul>
<li><a href="/jena-doc/download/index.html">Downloading Jena</a></li>
<li><a href="/jena-doc/download/maven.html">Using Maven</a></li>
<li><a href="/jena-doc/download/osgi.html">Using OSGi</a></li>
</ul>
<h1 id="help-and-support">Help and support</h1>
<ul>
<li><a href="/jena-doc/help_and_support/index.html">Getting help</a></li>
<li><a href="/jena-doc/help_and_support/bugs_and_suggestions.html">Bugs and suggestions</a></li>
</ul>
<h1 id="getting-started">Getting Started</h1>
<ul>
<li><a href="/jena-doc/getting_started/index.html">A first Jena project</a></li>
<li><a href="/jena-doc/getting_started/rdf_api.html">RDF API overview</a></li>
<li><a href="/jena-doc/getting_started/sparql.html">Querying RDF with SPARQL</a></li>
<li><a href="/jena-doc/getting_started/fuseki.html">Serving RDF over HTTP</a></li>
<li><a href="/jena-doc/getting_started/tell_me_how.html">Tell me how to ...</a></li>
</ul>
<h1 id="tutorials">Tutorials</h1>
<ul>
<li><a href="/jena-doc/tutorials/index.html">Tutorials index</a></li>
<li><a href="/jena-doc/tutorials/rdf_api.html">RDF tutorial</a></li>
<li><a href="/jena-doc/tutorials/sparql.html">SPARQL queries</a></li>
<li><a href="/jena-doc/tutorials/using_jena_with_eclipse.html">Using Jena with Eclipse</a></li>
</ul>
<h1 id="documentation">Documentation</h1>
<ul>
<li><a href="/jena-doc/documentation/index.html">Overview</a></li>
<li><a href="/jena-doc/documentation/javadoc/">Javadoc</a></li>
<li><a href="/jena-doc/documentation/rdf/index.html">RDF</a></li>
<li><a href="/jena-doc/documentation/io/index.html">I/O</a></li>
<li><a href="/jena-doc/documentation/query/index.html">SPARQL (ARQ)</a><ul>
<li><a href="/jena-doc/documentation/query/app_api.html">Application API</a></li>
<li><a href="/jena-doc/documentation/query/cmds.html">Command line utilities</a></li>
</ul>
</li>
<li><a href="/jena-doc/documentation/query/text-query.html">Text Search</a></li>
<li><a href="/jena-doc/documentation/tdb/index.html">TDB</a><ul>
<li><a href="/jena-doc/documentation/tdb/tdb_transactions.html">API for Transactions</a></li>
<li><a href="/jena-doc/documentation/tdb/assembler.html">Dataset Assembler</a></li>
</ul>
</li>
<li><a href="/jena-doc/documentation/serving_data/index.html">Fuseki: Serving Data</a></li>
<li><a href="/jena-doc/documentation/ontology/index.html">Ontology</a></li>
<li><a href="/jena-doc/documentation/inference/index.html">Inference</a></li>
<li><a href="/jena-doc/documentation/assembler/index.html">Assembler</a><ul>
<li><a href="/jena-doc/documentation/assembler/assembler-howto.html">Assembler how-to</a></li>
<li><a href="/jena-doc/documentation/assembler/inside-assemblers.html">Inside assemblers</a></li>
</ul>
</li>
<li><a href="/jena-doc/documentation/sdb/index.html">SDB</a></li>
<li><a href="/jena-doc/documentation/notes/index.html">Notes</a><ul>
<li><a href="/jena-doc/documentation/notes/concurrency-howto.html">Concurrency how-to</a></li>
<li><a href="/jena-doc/documentation/notes/event-handler-howto.html">Event handler how-to</a></li>
<li><a href="/jena-doc/documentation/notes/file-manager.html">File manager how-to</a></li>
<li><a href="/jena-doc/documentation/notes/model-factory.html">Model factory how-to</a></li>
<li><a href="/jena-doc/documentation/notes/rdf-frames.html">RDF frames</a></li>
<li><a href="/jena-doc/documentation/notes/reification.html">Reification how-to</a></li>
<li><a href="/jena-doc/documentation/notes/typed-literals.html">Typed literals how-to</a></li>
<li><a href="/jena-doc/documentation/notes/iri.html">Support for IRI's</a></li>
<li><a href="/jena-doc/documentation/notes/sse.html">SSE</a></li>
</ul>
</li>
<li><a href="/jena-doc/documentation/tools/index.html">Tools</a><ul>
<li><a href="/jena-doc/documentation/tools/schemagen.html">schemagen</a></li>
<li><a href="/jena-doc/documentation/tools/eyeball-getting-started.html">eyeball</a></li>
</ul>
</li>
</ul>
<h1 id="getting-involved">Getting Involved</h1>
<ul>
<li><a href="/jena-doc/getting_involved/index.html">Contributing to Jena</a><ul>
<li><a href="/jena-doc/getting_involved/reviewing_contributions.html">Reviewing Contributions</a></li>
</ul>
</li>
</ul>
<h1 id="asf-links">ASF links</h1>
<ul>
<li><a href="http://www.apache.org">Apache Software Foundation</a></li>
<li><a href="http://www.apache.org/licenses/LICENSE-2.0">License</a></li>
<li><a href="http://www.apache.org/foundation/thanks.html">Thanks</a></li>
<li><a href="http://www.apache.org/foundation/sponsorship.html">Become a Sponsor</a></li>
<li><a href="http://www.apache.org/security/">Security</a></li>
</ul>
  </div>

  <div id="content">
    <h1 class="title">SDB Database Notes</h1>
    <ul>
<li><a href="#db2">DB2</a></li>
<li><a href="#derby">Derby</a></li>
<li><a href="#ms-sql">MS SQL</a></li>
<li><a href="#mysql">MySQL</a></li>
<li><a href="#postgresql">PostgresQL</a></li>
</ul>
<h2 id="db2">DB2</h2>
<h3 id="database-creation">Database creation</h3>
<p>The database should be created with code set UTF-8 so unicode is
enabled (SDB creates tables CCSID UNICODE for full
internationalization support).</p>
<h2 id="derby">Derby</h2>
<h3 id="loading-restriction">Loading Restriction</h3>
<p>Only one load operation can be active at any one time. Limitations
on temporary tables in Derby mean the the loader tables are not
temporary and hence are shared by all connections.</p>
<h2 id="ms-sql">MS SQL</h2>
<p>The collation sequence for the database must be one that is binary
(BIN in the name). It does not matter which one is used. Without
BIN, string matching is case insensitive but RDF requires case
sensitive literals and IRIs. The normal layout is not affected by
this because it does not use string comparisons.</p>
<h2 id="mysql">MySQL</h2>
<h3 id="national-characters">National Characters</h3>
<p>SDB formats all table columns used for storing text in the MySQL
schema to UTF-8. However, this does not cause the data to be
transmitted in UTF-8 over the JDBC connection.</p>
<p>The best way is to run the server with a default character set of
UTF-8. This is set in the MySQL server configuration file:</p>
<div class="codehilite"><pre><span class="k">[mysql]</span>
<span class="na">default-character-set</span><span class="o">=</span><span class="s">utf8</span>
</pre></div>


<p>A less reliable way is to pass parameters to the JDBC driver in the
JDBC URL. The application will need to explicitly set the JDBC URL
in the
<a href="store_description.html" title="SDB/Store Description">store configuration</a>
file.</p>
<div class="codehilite"><pre> <span class="p">...</span><span class="o">?</span><span class="n">useUnicode</span><span class="o">=</span><span class="nb">true</span><span class="o">&amp;</span><span class="n">characterEncoding</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
</pre></div>


<h3 id="connection-timeouts">Connection timeouts</h3>
<p>If you get the connection timing out after (by default) 8 hours of
no activity, try setting <code>autoReconnect=true</code> in the JDBC URL.</p>
<h3 id="tuning">Tuning</h3>
<ol>
<li>For InndoDB, the critical parameter is
    <code>innodb_buffer_pool_size</code>. See the MySQL sample configuration files
    for details.</li>
<li>Using ANALYZE TABLE on the database tables can improve the
    choices made by the MySQL optimizer.</li>
</ol>
<h3 id="connection-timeout">Connection Timeout</h3>
<p>MySQL closes the JDBC connection after a period of no use (8 hours
by default).</p>
<p>While deprecated my MySQL, <code>?autoReconnect=true</code> may help here.</p>
<p>Other ways of addressing the problem are to make a simple query
call on a regular basis just to keep the connection alive (e.g.
<code>SELECT * { &lt;http://example/junk&gt; &lt;http://example/junk&gt; &lt;http://example/junk&gt; }</code>).</p>
<p>Some connection pool systems automatic compensate for this feature
of MySQL.</p>
<h2 id="postgresql">PostgresQL</h2>
<h3 id="databases-must-use-utf-8-encoding">Databases must use UTF-8 encoding</h3>
<p>Create SDB stores with encoding UTF-8.</p>
<p>International character sets can cause corrupted databases
otherwise. The database will not pass the SDB test suite.</p>
<p>Set this when creating the database with pgAdmin or if you use the
command line, for example:</p>
<div class="codehilite"><pre> <span class="n">CREATE</span> <span class="n">DATABASE</span> <span class="s">&quot;YourStoreName&quot;</span>
 <span class="n">WITH</span> <span class="n">OWNER</span> <span class="o">=</span> <span class="s">&quot;user&quot;</span>
      <span class="n">ENCODING</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">UTF8</span><span class="err">&#39;</span>
      <span class="n">TABLESPACE</span> <span class="o">=</span> <span class="n">pg_default</span><span class="p">;</span>
</pre></div>


<h3 id="improving-loading-rates">Improving loading rates</h3>
<p>The index layout ("layout2/index") usually loads faster than the
hash form.</p>
<p><em>Existing store</em></p>
<p>When loading into an existing store, where there is existing data
and <code>ANALYZE</code> has been run, the process is:</p>
<ul>
<li>
<p>Drop indexes</p>
<p>sdbconfig --drop</p>
</li>
<li>
<p>Load data</p>
<p>sdbload file</p>
</li>
<li>
<p>Redo the indexes</p>
<p>sdbconfig --index</p>
</li>
</ul>
<p><em>Fresh store</em></p>
<p>PostgreSQL needs statistics to improve load performance through the
use of <code>ANALYSE</code>.</p>
<p>When loading the first time, there are no statistics so, for a
large load, it is advisable to load a sample, run <code>ANALYSE</code> and
then load the whole data.</p>
<ul>
<li>
<p>Create the database without indexes (just the primary keys).</p>
<p>sdbconfig --format</p>
</li>
<li>
<p>Load a sample of the triples (say, a 100K or a million triples</p>
<ul>
<li>until</li>
</ul>
</li>
</ul>
<p>the load rate starts to drop appreciably). The sample must be
representative of the data.</p>
<div class="codehilite"><pre> <span class="n">sdbload</span> <span class="o">--</span><span class="n">time</span> <span class="n">sample</span>
</pre></div>


<ul>
<li>
<p>Run <code>ANALYZE</code> on the database.</p>
</li>
<li>
<p>If your sample is one part of a large set of files, this set is
    not necessary at all. If you are loading one single large file then
    you might wish to empty the database. This is only needed if the
    data has bNodes in</p>
</li>
</ul>
<p>it because the load process suppresses duplicates.</p>
<div class="codehilite"><pre> <span class="n">sdbconfig</span> <span class="o">--</span><span class="n">truncate</span>
</pre></div>


<ul>
<li>
<p>Now load the data or rest of the data.</p>
<p>sdbload --time file</p>
</li>
<li>
<p>Add the indexes. This only takes a few minutes even on a very
    large store but calculating them during loading (that is,
    <code>--create</code>, not <code>--format</code>) is noticeably slower.</p>
<p>sdbconfig --index</p>
</li>
<li>
<p>Run <code>ANALYZE</code> on the database again.</p>
</li>
</ul>
<h3 id="tuning_1">Tuning</h3>
<p>It is essential to run the PostgreSQL ANALYZE command on a
database, either during or after building. This is done via the
command line <code>psql</code> or via <code>pgAdmin</code>. The PostgreSQL documentation
describes ways to run this as a background daemon.</p>
<p>Various of the PostgreSQL configuration parameters will affect
performance, particularly <code>effective_cache_size</code>. The parameter
<code>enable_seqscan</code> <em>may</em> help avoid some unexpected slow queries.</p>
  </div>

  <div id="footer">
    <div class="copyright">
      <p>
        Copyright &copy; 2011&ndash;2013 The Apache Software Foundation, Licensed under
        the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>.
        <br />
        Apache Jena, Jena, the Apache Jena project logo,
        Apache and the Apache feather logos are trademarks of The Apache Software Foundation.
      </p>
    </div>
  </div>

</body>
</html>
